package com.marchinelearning.project;

import java.io.BufferedReader;
import java.io.File;
import java.io.FileNotFoundException;
import java.io.FileReader;
import java.io.IOException;
import java.io.PrintWriter;
import java.io.UnsupportedEncodingException;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.HashSet;
import java.util.LinkedHashMap;
import java.util.Map;
import java.util.Scanner;
import java.util.Set;

public class ArffConverter {
	
	private ArffConverter() { }
	
	private static Set<String> buildLabelSet() {
		Set<String> labelSet = new HashSet<String>();
		for (int i = 1; i <= 9; i++) {
			labelSet.add(String.valueOf(i));
		}
		return labelSet;
	}
	
	private static LinkedHashMap<String, Integer> buildMasterAttrMap(String attrPath) {
		LinkedHashMap<String, Integer> attrMap = new LinkedHashMap<String, Integer>();
		try (BufferedReader br = new BufferedReader(new FileReader(attrPath))) {
			int idx = 0; 
			String attr;
			while ((attr = br.readLine()) != null) {
				attrMap.put(attr, idx++);
			}
		} catch (IOException e) {
			e.printStackTrace();
			System.out.println("Error: buildAttrMap()");
		}
		return attrMap;
	}
	
	private static String[] getInputFileList(String inputDir) {
		File inputDirectory = new File(inputDir);
		return inputDirectory.list();
	}
	
	private static String parseApiString(String line) {
		String[] arr = line.split("\\s+");
		StringBuilder sb = new StringBuilder();
		for (int i = 0; i < 4; i++) {
			sb.append(arr[i]);
		}
		return sb.toString();
	}
	
	private static String parseNGramWithSpaces(String line) {
		String[] arr = line.split("\\s+");
		StringBuilder sb = new StringBuilder();
		for (int i = 0; i < 4; i++) {
			sb.append(arr[i]);
		}
		return sb.toString();
	}
	
	private static ArrayList<Integer> createAttrListForFile(LinkedHashMap<String, Integer> attrMap, Set<String> labelSet, String inputFile, boolean useNgrams) {
		ArrayList<Integer> attrList = new ArrayList<>();
		try (BufferedReader br = new BufferedReader(new FileReader(inputFile))) {
			String attr;
			while ((attr = br.readLine()) != null) {
				Integer attrIndex = attrMap.get(useNgrams ? parseNGramWithSpaces(attr) : attr);
				if (attrIndex != null) {
					attrList.add(attrIndex);
				}
			}
		} catch (IOException e) {
			e.printStackTrace();
			System.out.println("Error: createAttrList()");
		}
		return attrList;
	}
	
	private static String attrListToString(ArrayList<Integer> attrList, String label, boolean isTestSet) {
		boolean empty = true;
		StringBuilder sb = new StringBuilder();
		sb.append("{");
		for (int i = 0; i < attrList.size(); i++) {
			sb.append(attrList.get(i)).append(" 1, ");
			empty = false;
		}
		/*
		if (empty)
			sb.append(" }");
		else if (isTestSet)
			sb.replace(sb.length()-2, sb.length(), "}");
		else
			sb.append("501 ").append(label).append("}");
			*/
		sb.append("501 ").append(label).append("}");
		return sb.toString();
	}
	
	private static void printArffMetaData(LinkedHashMap<String, Integer> attrMap, PrintWriter pw) {
		pw.println("@RELATION malware\n");
		
		for (Map.Entry<String, Integer> entry : attrMap.entrySet()) {
			pw.println("@ATTRIBUTE "+entry.getKey()+"  NUMERIC");
		}
		pw.println("@ATTRIBUTE family {1,2,3,4,5,6,7,8,9}\n");
		pw.println("\n@DATA");
	}
	
	private static Map<String, String> buildTrainLabelsMap(String trainLabelsCsv) {
		Map<String, String> trainLabelsMap = new HashMap<>();
		Scanner in;
		try {
			in = new Scanner(new File(trainLabelsCsv));
			while (in.hasNext()) {
				String[] lineParts = in.nextLine().split(",");
				trainLabelsMap.put(lineParts[0].replace("\"", ""), lineParts[1]);
			}

			in.close();
		} catch (FileNotFoundException e) {
			e.printStackTrace();
		}
		return trainLabelsMap;
	}
	
	private static String extractMalwareIdFromPath(String fileName, boolean useNgrams) {
		String suffix = (useNgrams) ? Constants.ngramsTrainingExampleSuffix : ".asm";
		String trainingExamplesPath = (useNgrams) ? Constants.NgramTrainingExamplesPath() : Constants.apiStringsPath;
		return fileName
				.replace(trainingExamplesPath,"")
				.replace(suffix, "");
	}
	
	/**
	 * Creates the corresponding sparse-format ARFF file given:
	 * 	- a list of "master" attributes
	 *  - a directory containing files with a list of attributes for each malware instance
	 *  - the name of the file to write the ARFF output to
	 * @param masterAttrList
	 * @param inputDir
	 * @param outputArff
	 */
	public static void run(String trainLabelsCsv, String masterAttrList, String inputDir, String outputArff, boolean useNgrams) {
		PrintWriter pw = null;
		try {
			pw = new PrintWriter(outputArff, "UTF-8");
			LinkedHashMap<String, Integer> attrMap = buildMasterAttrMap(masterAttrList);
			Set<String> labelSet = buildLabelSet();
			Map<String, String> trainLabelsMap = buildTrainLabelsMap(trainLabelsCsv);
			
			printArffMetaData(attrMap, pw);
			
			for (String file : getInputFileList(inputDir)) {
				System.out.println(inputDir+file);
				ArrayList<Integer> attrList = createAttrListForFile(attrMap, labelSet, inputDir+file, useNgrams);
				//String label = (isTestSet) ? null : trainLabelsMap.get(extractMalwareIdFromPath(file));
				String label = trainLabelsMap.get(extractMalwareIdFromPath(file,useNgrams));
				System.out.println(label);
				String arffRow = attrListToString(attrList, label, useNgrams);
				pw.println(arffRow);
			}
			
		} catch (FileNotFoundException | UnsupportedEncodingException e) {
			e.printStackTrace();
		}
		finally {
			if (pw != null)
				pw.close();
		}
	}

	
	public static void main(String[] args) throws FileNotFoundException, UnsupportedEncodingException {
		//ngram examples
		/*ArffConverter.run(
				Constants.trainLabelsFilename,
				Constants.masterAttrList,
				Constants.NgramTrainingExamplesPath(),
				Constants.outputArffFileName,
				true);
				*/
		
		//api examples
		ArffConverter.run(
				Constants.trainLabelsFilename,
				Constants.apiMasterAttrList,
				Constants.apiStringsPath,
				Constants.outputArffFileName_api,
				false);
	}
	  
}
