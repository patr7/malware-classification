#!/bin/bash
shopt -s nullglob

# parse imported libraries from training examples
# and write a list of each .asm file's attributes to another file
# Also, match each .asm file's class-label from trainLabels.csv and 
# insert as last item in attribute list

TRAIN_IN=$1/*.asm
TRAIN_LABELS=$2
TRAIN_OUT=$3

for F in $TRAIN_IN
do
    asm_file=$(basename $F)
    out_path=$TRAIN_OUT/$asm_file

    grep -ao '_stdcall.*\|extrn.*' $F | sed 's/[$@\?0,\x27"]//g' | awk -F'[ :(]' 'length($2) > 4 { print $2 }' | sort | uniq >>$out_path

    grep -f <(echo $asm_file | awk '{ print substr($0, 1, 20) }') $TRAIN_LABELS | awk -F',' '{ print $2}' >>$out_path
done

exit 0

