#!/bin/bash
shopt -s nullglob

# parse imported libraries from training examples
# and write a list of each .asm file's attributes to another file
# Also, match each .asm file's class-label from trainLabels.csv and 
# insert as last item in attribute list

TRAIN_IN=$1/*.asm
TRAIN_LABELS=$2
TRAIN_OUT=$3

for F in $TRAIN_IN
do
    # name of the .asm file
    asm_file=$(basename $F)

    # absolute path of where to write the file of attributes for this .asm file
    out_path=$TRAIN_OUT/$asm_file

    # temporary file used for processing
    TEMP=$(mktemp)
    
    # grep each file for lib functions | remove any [$0',"@?] | only keep function name if at least 5 chars >> write to temp output file  
    grep -ao '_stdcall.*\|extrn.*' $F | sed 's/[$@\?0,\x27"]//g' | awk -F'[ :(]' 'length($2) > 4 { print $2 }' >>$TEMP

    # sort | dedupe >> write to new .asm output file
    sort $TEMP | uniq >>$out_path

    # delete the temporary file
    rm $TEMP

    # grep name of .asm file in trainLabels.csv, and append the class-label to the output file
    grep -f <(echo $asm_file | awk '{ print substr($0, 1, 20) }') $TRAIN_LABELS | awk -F',' '{ print $2}' >>$out_path
done

exit 0

